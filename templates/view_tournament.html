{% extends 'base.html' %}

{% block header %}{{ tournament.name }}{% endblock %}

{% block script %}
    <script type="text/javascript" src="/static/js/d3.v2.min.js"></script>
{% endblock %}

{% block style %}
    <style>
      .nodeText {
{#        background-color: #ffffff;#}
        cursor: pointer;
        font-family: Helvetica,'Ludica Grande',sans-serif;
        font-size: 14pt;
        font-weight: bold;
        text-anchor: middle;
        dominant-baseline: central;
      }
      .nodeBox {
        cursor: pointer;
        fill: url(#ButtonGradient);
        stroke: steelblue;
        stroke-width: 1px;
      }
      .nodeLink {
        fill: none;
        stroke: lightslategray;
        stroke-width: 2px;
      }

        .form-match {
            margin-right: 10px;
        }

      .form-horizontal .controls {
          margin-left: 90px;
      }

      .form-horizontal .control-label {
          width: 80px;
      }


        .match-wrapper {
            padding-right: 10px;
        }
    </style>
{% endblock %}

{% block content %}
    <div id="bracket" style="margin:0px;padding:0px;">
    </div>

    {# D3 script MUST appear after the #bracket div has been instantiated #}
    <script type="text/javascript">

// Initialize size values.
var m = { "t": 20, "r": 40, "b": 20, "l": 120 },
    width = Math.floor($(document).width() - (2 * $("#bracket").parent().position().left)) - m["r"] - m["l"],
    height = Math.floor(width / (16.0 / 9.0)) - m["t"] - m["b"] + 500,

    halfWidth = Math.floor(width / 2.0),
    halfHeight = Math.floor(height / 2.0),
    duration = 0,
    i = 0, j = 0,
    root;

// Method for finding node children.
get_children = function(d) {
    child_matches = false;
    is_playable_match = false;
    if (d.participants) {
        if (d.participants.length == 2) {
            is_playable_match = true;
        }
    }

    if (is_playable_match) {
        return d.children;
    } else {
        return d.children;
    }
}

// Initialize the D3 tree.
var tree = d3.layout.tree()
    .size([height, width])
    .children(get_children);

// Initialize SVG.
var svg = d3.select("#bracket").append("svg")
    .attr("width", width + m["r"] + m["l"])
    .attr("height", height + m["t"] + m["b"])
    .attr("style", "margin:0px;padding:0px;")
    .attr("xmlns", "http://www.w3.org/2000/svg");
var defs = svg.append("defs");
var bracket = svg.append("g")
    .attr("transform", "translate(" + m["l"] + "," + m["t"] + ")");

json_display = function(json) {
    root = json.matches;
    root.x0 = halfHeight;
    root.y0 = halfWidth;
    update(root);
}

update = function(source) {

    var nodes = tree.nodes(root);
    var links = tree.links(nodes);

    var node = bracket.selectAll("g.node")
      .data(nodes);

    var nodeEnter = node.enter().append("g")
        .attr("class", "node")
        .attr("transform", function(d) {
        return "translate(" + (width - source.y0) + "," + source.x0 + ")";
    });

    nodeEnter.append("foreignObject")
            .attr("width", 200)
            .attr("height", 140)
            .attr("class", "nodeText")
            .append('xhtml:nodeForm')
            .html(function(d) {
                var team1 = '';
                var key1 = '';
                var score1 = '';
                var team2 = '';
                var key2 = '';
                var score2 = '';
                if (d.participants) {
                    if (d.participants.length > 0) {
                        team1 = d.participants[0].name;
                        key1 = d.participants[0].key;
                        score1 = d.participants[0].score;
                        team2 = d.participants[1].name;
                        key2 = d.participants[1].key;
                        score2 = d.participants[1].score;
                    } else {
                        return "<div class='well'>Finish earlier matches</div>"
                    }
                }


                if (d.status < 1) {
                    var output = "<form class='form-horizontal form-match'>" +
                            "<div class='control-group'>" +
                            "<label class='control-label nodeText'>" + team1 + "</label>" +
                            "<div class='controls'>" +
                            "<input class='update-score span1' type='text' value='" + score1 + "'> " +
                            "<input type='hidden' id='participant1' value='" + key1 + "'>" +
                            "</div>" +
                            "</div>" +
                            "<div class='control-group'>" +
                            "<label class='control-label nodeText'>" + team2 + "</label>" +
                            {#                                "<label class='control-label nodeText'> Finish </label>" +#}
                            "<div class='controls'>" +
                            "<input class='update-score span1' type='text' value='" + score2 + "'> " +
                            "<button class='btn btn-mini btn-block btn-inverse done' id='" + d.match_key +  "-finish' style='margin-top: 10px;'>Finish</button>" +
                            "<input type='hidden' id='participant2' value='" + key2 + "'>" +
                            "</div>" +

                            "</div>" +

                            "</form>"
                } else {
                    var output = "<form class='form-horizontal form-match'>" +
                            "<div class='control-group'>" +
                            "<label class='control-label nodeText'>" + team1 + "</label>" +
                            "<div class='controls'>" +
                            score1 +
                            "</div>" +
                            "</div>" +
                            "<div class='control-group'>" +
                            "<label class='control-label nodeText'>" + team2 + "</label>" +
                            {#                                "<label class='control-label nodeText'> Finish </label>" +#}
                            "<div class='controls'>" +
                            score2 +
                            "</div>" +
                            "</div>" +
                            "</form>"
                }

                return "<div class='well match-wrapper' id=" + d.match_key + "> " +
                        output +
                        "</div>"});


    nodeEnter.selectAll("text").each(function(d) {
        var w = $(this).width();
        var h = $(this).height();
        var wm = 20;
        var hm = 10;
        d3.select(this.parentNode)
            .attr("width", w + wm)
            .attr("height", h + hm)
            .attr("x", (-1) * ((w + wm) / 2))
            .attr("y", (-1) * ((h + hm) / 2))
            .insert("rect", "text")
            .attr("class", "nodeBox")
            .attr("width", w + wm)
            .attr("height", h + hm)
            .attr("x", (-1) * ((w + wm) / 2))
            .attr("y", (-1) * ((h + hm) / 2))
            .attr("rx", 5)
            .attr("ry", 5);
    });

    node.transition()
        .duration(duration)
        .attr("transform", function(d) {
            var output = "";
            if (d.depth < 1) {
                output = "translate(" + (width - d.y - 200) + "," + (d.x - 42) + ")"
            } else {
                output = "translate(" + (width - d.y) + "," + (d.x - 60) + ")"
            }
            return output;
    });

  var elbow = function (d, i) {
    return "M" + (width - d.source.y) + "," + d.source.x +
      "H" + (((width - d.source.y) + (width - d.target.y)) / 2) +
      "V" + d.target.x + "H" + (width - d.target.y);
  };

  var link = bracket.selectAll("path.nodeLink")
      .data(links);

  var linkEnter = link.enter().insert("path", "g")
      .attr("class", "nodeLink")
      .attr("d", function(d) {
        var o = {x: source.x0, y: source.y0};
        return elbow({source: o, target: o});
      });

  linkEnter.transition()
      .duration(duration)
      .attr("d", elbow);
}

    d3.json("/tournament/json/{{ tournament_key }}/", json_display);
    </script>

    <script type="text/javascript">
        $(document).ready(function(){

            //Handler for updating a score on a match.
            $('.update-score').live('blur', function(){
                var url = '/tournament/update_match/';
                var match_key = $(this).parents().find('.match-wrapper').attr('id');
                var match_wrapper = $("#" + match_key);
                var p1_obj = match_wrapper.find('#participant1');
                var p1_key = p1_obj.val();
                var p2_obj = match_wrapper.find('#participant2');
                var p2_key = p2_obj.val();
                var p1_score = $(this).parents().find('.update-score').eq(1).val();
                var p2_score = $(this).parents().find('.update-score').first().val();

                $.getJSON(url,
                        {'match':{'match_key': match_key, 'match_status':'0', 'player1':{'key':p1_key, 'score':p1_score}, 'player2':{'key':p2_key, 'score':p2_score}}},
                        function(data){
{#                            $('#' + data.p1_key + '-score > .score').html(data.p1_score);#}
{#                            $('#' + data.p2_key + '-score > .score').html(data.p2_score);#}
                            match_wrapper.css('background-color', '#ccd5ec').animate({backgroundColor: "#F9F9F9"}, 1000)
                        }
                );
            });

            $('.done').live('click', function(){
                var url2 = '/tournament/update_match/';
                $.getJSON(url2,
                        {'match':{'match_key':"ag9kZXZ-MzE5LXByb2plY3RyHQsSClRvdXJuYW1lbnQYtAIMCxIFTWF0Y2gYtgIM",'match_status':'1'}},
                        function(data){
                            console.log("Done");
                        }
                );
            });
        });



    </script>

{% endblock %}
